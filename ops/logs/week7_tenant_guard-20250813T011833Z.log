
PLAY [Week 7 – Tenant guard (SQLite dev) + tests + git] ************************

TASK [Ensure app folder exists] ************************************************
ok: [localhost]

TASK [Stop if app not found] ***************************************************
skipping: [localhost]

TASK [Write lib/db-tenant.ts (idempotent, hardened + proxy fallback)] **********
ok: [localhost]

TASK [Ensure routes import dbForTenant] ****************************************
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/staff/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/service/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/appointment/route.ts)

TASK [Remove stale top-level model lines] **************************************
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/staff/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/service/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/appointment/route.ts)

TASK [Insert marker above GET handlers] ****************************************
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/staff/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/service/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/appointment/route.ts)

TASK [Inject tenant block after GET markers] ***********************************
ok: [localhost] => (item={'path': '/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts', 'entity': 'customer'})
ok: [localhost] => (item={'path': '/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/staff/route.ts', 'entity': 'staff'})
ok: [localhost] => (item={'path': '/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/service/route.ts', 'entity': 'service'})
ok: [localhost] => (item={'path': '/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/appointment/route.ts', 'entity': 'appointment'})

TASK [Insert marker above POST handlers] ***************************************
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/staff/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/service/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/appointment/route.ts)

TASK [Inject tenant block after POST markers] **********************************
ok: [localhost] => (item={'path': '/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts', 'entity': 'customer'})
ok: [localhost] => (item={'path': '/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/staff/route.ts', 'entity': 'staff'})
ok: [localhost] => (item={'path': '/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/service/route.ts', 'entity': 'service'})
ok: [localhost] => (item={'path': '/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/appointment/route.ts', 'entity': 'appointment'})

TASK [Ensure Tenant model exists (append if missing)] **************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [Stat checkout route] *****************************************************
ok: [localhost]

TASK [Checkout API uses dbForTenant import] ************************************
ok: [localhost]

TASK [Remove module-level PrismaClient in checkout] ****************************
ok: [localhost]

TASK [Inject tenant-scoped db in POST handler (checkout)] **********************
ok: [localhost]

TASK [Ensure .env has DATABASE_URL (SQLite dev)] *******************************
ok: [localhost]

TASK [Prisma generate] *********************************************************
changed: [localhost]

TASK [Prisma migrate dev (add tenant fields)] **********************************
changed: [localhost]

TASK [Unit test for tenant guard (Jest)] ***************************************
ok: [localhost]

TASK [Ensure playwright config uses ./tests] ***********************************
ok: [localhost]

TASK [E2E – customer isolation via API] ****************************************
ok: [localhost]

TASK [Remove legacy ANSIBLE tenant blocks (GET)] *******************************
changed: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/staff/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/service/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/appointment/route.ts)

TASK [Remove legacy ANSIBLE tenant blocks (POST)] ******************************
changed: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/staff/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/service/route.ts)
ok: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/appointment/route.ts)

TASK [Remove any top-level 'const model = db.x;' left behind] ******************
changed: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts)
changed: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/staff/route.ts)
changed: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/service/route.ts)
changed: [localhost] => (item=/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/appointment/route.ts)

TASK [Run unit tests (Jest)] ***************************************************
changed: [localhost]

TASK [Run e2e (Playwright)] ****************************************************
fatal: [localhost]: FAILED! => {"changed": true, "cmd": "npm run -s e2e", "delta": "0:00:33.270889", "end": "2025-08-12 18:19:17.325175", "msg": "non-zero return code", "rc": 1, "start": "2025-08-12 18:18:44.054286", "stderr": "\u001b[2m[WebServer] \u001b[22m \u001b[31m\u001b[1m⨯\u001b[22m\u001b[39m ./app/api/customer/route.ts\n\u001b[2m[WebServer] \u001b[22mError: \n\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `tenantId` is defined multiple times\n\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:14:1]\n\u001b[2m[WebServer] \u001b[22m \u001b[2m14\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET\n\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^^^^|^^^\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :           \u001b[31;1m`-- \u001b[31;1mprevious definition of `tenantId` here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END\n\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST\n\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^^^^|^^^\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :           \u001b[33;1m`-- \u001b[33;1m`tenantId` redefined here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END\n\u001b[2m[WebServer] \u001b[22m    `----\n\u001b[2m[WebServer] \u001b[22m\n\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `db` is defined multiple times\n\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:15:1]\n\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET\n\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^|\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :        \u001b[31;1m`-- \u001b[31;1mprevious definition of `db` here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END\n\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST\n\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^|\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :        \u001b[33;1m`-- \u001b[33;1m`db` redefined here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END\n\u001b[2m[WebServer] \u001b[22m    `----\n\u001b[2m[WebServer] \u001b[22m\n\u001b[2m[WebServer] \u001b[22mImport trace for requested module:\n\u001b[2m[WebServer] \u001b[22m./app/api/customer/route.ts\n\u001b[2m[WebServer] \u001b[22m \u001b[31m\u001b[1m⨯\u001b[22m\u001b[39m ./app/api/customer/route.ts\n\u001b[2m[WebServer] \u001b[22mError: \n\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `tenantId` is defined multiple times\n\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:14:1]\n\u001b[2m[WebServer] \u001b[22m \u001b[2m14\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET\n\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^^^^|^^^\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :           \u001b[31;1m`-- \u001b[31;1mprevious definition of `tenantId` here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END\n\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST\n\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^^^^|^^^\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :           \u001b[33;1m`-- \u001b[33;1m`tenantId` redefined here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END\n\u001b[2m[WebServer] \u001b[22m    `----\n\u001b[2m[WebServer] \u001b[22m\n\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `db` is defined multiple times\n\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:15:1]\n\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET\n\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^|\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :        \u001b[31;1m`-- \u001b[31;1mprevious definition of `db` here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END\n\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST\n\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^|\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :        \u001b[33;1m`-- \u001b[33;1m`db` redefined here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END\n\u001b[2m[WebServer] \u001b[22m    `----\n\u001b[2m[WebServer] \u001b[22m\n\u001b[2m[WebServer] \u001b[22mImport trace for requested module:\n\u001b[2m[WebServer] \u001b[22m./app/api/customer/route.ts\n\u001b[2m[WebServer] \u001b[22m \u001b[31m\u001b[1m⨯\u001b[22m\u001b[39m ./app/api/customer/route.ts\n\u001b[2m[WebServer] \u001b[22mError: \n\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `tenantId` is defined multiple times\n\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:14:1]\n\u001b[2m[WebServer] \u001b[22m \u001b[2m14\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET\n\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^^^^|^^^\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :           \u001b[31;1m`-- \u001b[31;1mprevious definition of `tenantId` here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END\n\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST\n\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^^^^|^^^\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :           \u001b[33;1m`-- \u001b[33;1m`tenantId` redefined here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END\n\u001b[2m[WebServer] \u001b[22m    `----\n\u001b[2m[WebServer] \u001b[22m\n\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `db` is defined multiple times\n\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:15:1]\n\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET\n\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^|\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :        \u001b[31;1m`-- \u001b[31;1mprevious definition of `db` here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END\n\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST\n\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN\n\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';\n\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);\n\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^|\u001b[0m\n\u001b[2m[WebServer] \u001b[22m    :        \u001b[33;1m`-- \u001b[33;1m`db` redefined here\u001b[0m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | \n\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END\n\u001b[2m[WebServer] \u001b[22m    `----\n\u001b[2m[WebServer] \u001b[22m\n\u001b[2m[WebServer] \u001b[22mImport trace for requested module:\n\u001b[2m[WebServer] \u001b[22m./app/api/customer/route.ts", "stderr_lines": ["\u001b[2m[WebServer] \u001b[22m \u001b[31m\u001b[1m⨯\u001b[22m\u001b[39m ./app/api/customer/route.ts", "\u001b[2m[WebServer] \u001b[22mError: ", "\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `tenantId` is defined multiple times", "\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:14:1]", "\u001b[2m[WebServer] \u001b[22m \u001b[2m14\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET", "\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^^^^|^^^\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :           \u001b[31;1m`-- \u001b[31;1mprevious definition of `tenantId` here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END", "\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST", "\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^^^^|^^^\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :           \u001b[33;1m`-- \u001b[33;1m`tenantId` redefined here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END", "\u001b[2m[WebServer] \u001b[22m    `----", "\u001b[2m[WebServer] \u001b[22m", "\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `db` is defined multiple times", "\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:15:1]", "\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET", "\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^|\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :        \u001b[31;1m`-- \u001b[31;1mprevious definition of `db` here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END", "\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST", "\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^|\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :        \u001b[33;1m`-- \u001b[33;1m`db` redefined here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END", "\u001b[2m[WebServer] \u001b[22m    `----", "\u001b[2m[WebServer] \u001b[22m", "\u001b[2m[WebServer] \u001b[22mImport trace for requested module:", "\u001b[2m[WebServer] \u001b[22m./app/api/customer/route.ts", "\u001b[2m[WebServer] \u001b[22m \u001b[31m\u001b[1m⨯\u001b[22m\u001b[39m ./app/api/customer/route.ts", "\u001b[2m[WebServer] \u001b[22mError: ", "\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `tenantId` is defined multiple times", "\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:14:1]", "\u001b[2m[WebServer] \u001b[22m \u001b[2m14\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET", "\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^^^^|^^^\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :           \u001b[31;1m`-- \u001b[31;1mprevious definition of `tenantId` here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END", "\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST", "\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^^^^|^^^\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :           \u001b[33;1m`-- \u001b[33;1m`tenantId` redefined here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END", "\u001b[2m[WebServer] \u001b[22m    `----", "\u001b[2m[WebServer] \u001b[22m", "\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `db` is defined multiple times", "\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:15:1]", "\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET", "\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^|\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :        \u001b[31;1m`-- \u001b[31;1mprevious definition of `db` here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END", "\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST", "\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^|\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :        \u001b[33;1m`-- \u001b[33;1m`db` redefined here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END", "\u001b[2m[WebServer] \u001b[22m    `----", "\u001b[2m[WebServer] \u001b[22m", "\u001b[2m[WebServer] \u001b[22mImport trace for requested module:", "\u001b[2m[WebServer] \u001b[22m./app/api/customer/route.ts", "\u001b[2m[WebServer] \u001b[22m \u001b[31m\u001b[1m⨯\u001b[22m\u001b[39m ./app/api/customer/route.ts", "\u001b[2m[WebServer] \u001b[22mError: ", "\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `tenantId` is defined multiple times", "\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:14:1]", "\u001b[2m[WebServer] \u001b[22m \u001b[2m14\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET", "\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^^^^|^^^\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :           \u001b[31;1m`-- \u001b[31;1mprevious definition of `tenantId` here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END", "\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST", "\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^^^^|^^^\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :           \u001b[33;1m`-- \u001b[33;1m`tenantId` redefined here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END", "\u001b[2m[WebServer] \u001b[22m    `----", "\u001b[2m[WebServer] \u001b[22m", "\u001b[2m[WebServer] \u001b[22m  \u001b[31mx\u001b[0m the name `db` is defined multiple times", "\u001b[2m[WebServer] \u001b[22m    ,-[\u001b[36;1;4m/Users/akhil/erp-platform/apps/generated/demo-salon/app/api/customer/route.ts\u001b[0m:15:1]", "\u001b[2m[WebServer] \u001b[22m \u001b[2m15\u001b[0m | // TENANT-BLOCK-GET", "\u001b[2m[WebServer] \u001b[22m \u001b[2m16\u001b[0m | // BEGIN TENANT GET customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m17\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m \u001b[2m18\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m    : \u001b[31;1m      ^|\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :        \u001b[31;1m`-- \u001b[31;1mprevious definition of `db` here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m19\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m20\u001b[0m | // BEGIN TENANT GET customer // END", "\u001b[2m[WebServer] \u001b[22m \u001b[2m21\u001b[0m | // TENANT-BLOCK-POST", "\u001b[2m[WebServer] \u001b[22m \u001b[2m22\u001b[0m | // BEGIN TENANT POST customer // BEGIN", "\u001b[2m[WebServer] \u001b[22m \u001b[2m23\u001b[0m | const tenantId = req.headers.get('x-tenant-id') ?? 'tenantA';", "\u001b[2m[WebServer] \u001b[22m \u001b[2m24\u001b[0m | const db = dbForTenant(tenantId);", "\u001b[2m[WebServer] \u001b[22m    : \u001b[33;1m      ^|\u001b[0m", "\u001b[2m[WebServer] \u001b[22m    :        \u001b[33;1m`-- \u001b[33;1m`db` redefined here\u001b[0m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m \u001b[2m25\u001b[0m | ", "\u001b[2m[WebServer] \u001b[22m \u001b[2m26\u001b[0m | // BEGIN TENANT POST customer // END", "\u001b[2m[WebServer] \u001b[22m    `----", "\u001b[2m[WebServer] \u001b[22m", "\u001b[2m[WebServer] \u001b[22mImport trace for requested module:", "\u001b[2m[WebServer] \u001b[22m./app/api/customer/route.ts"], "stdout": "\nRunning 3 tests using 3 workers\n\n  ✘  1 tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id (666ms)\n  ✘  2 tests/checkout-zip.spec.ts:3:5 › ZIP override affects tax and total (adaptive tip) (30.0s)\n  ✘  3 tests/checkout.spec.ts:3:5 › checkout computes tax and writes ledger (30.0s)\n\n\n  1) tests/checkout-zip.spec.ts:3:5 › ZIP override affects tax and total (adaptive tip) ────────────\n\n    \u001b[31mTest timeout of 30000ms exceeded.\u001b[39m\n\n    Error: locator.fill: Test timeout of 30000ms exceeded.\n    Call log:\n    \u001b[2m  - waiting for getByRole('textbox', { name: /Item name/i }).first()\u001b[22m\n\n\n       5 |\n       6 |   // One $100 line item\n    >  7 |   await page.getByRole('textbox', { name: /Item name/i }).first().fill('Demo Item');\n         |                                                                   ^\n       8 |   const amountInputs = await page.getByPlaceholder('Amount').all();\n       9 |   await amountInputs[0].fill('100');\n      10 |\n        at /Users/akhil/erp-platform/apps/generated/demo-salon/tests/checkout-zip.spec.ts:7:67\n\n    Error Context: test-results/checkout-zip-ZIP-override--428f9-tax-and-total-adaptive-tip-/error-context.md\n\n  2) tests/checkout.spec.ts:3:5 › checkout computes tax and writes ledger ──────────────────────────\n\n    \u001b[31mTest timeout of 30000ms exceeded.\u001b[39m\n\n    Error: locator.click: Test timeout of 30000ms exceeded.\n    Call log:\n    \u001b[2m  - waiting for getByRole('button', { name: 'Compute & Save' })\u001b[22m\n\n\n       5 |\n       6 |   // Ensure default row exists\n    >  7 |   await page.getByRole('button', { name: 'Compute & Save' }).click();\n         |                                                              ^\n       8 |\n       9 |   // Wait for totals to render\n      10 |   await expect(page.getByText('Subtotal:')).toBeVisible();\n        at /Users/akhil/erp-platform/apps/generated/demo-salon/tests/checkout.spec.ts:7:62\n\n    Error Context: test-results/checkout-checkout-computes-tax-and-writes-ledger/error-context.md\n\n  3) tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id ────────────────────\n\n    Error: \u001b[2mexpect(\u001b[22m\u001b[31mreceived\u001b[39m\u001b[2m).\u001b[22mtoBeTruthy\u001b[2m()\u001b[22m\n\n    Received: \u001b[31mfalse\u001b[39m\n\n       5 |     data: { name: 'Alice A' }\n       6 |   });\n    >  7 |   expect(createA.ok()).toBeTruthy();\n         |                        ^\n       8 |   const createB = await request.post('/api/customer', {\n       9 |     headers: { 'x-tenant-id': 'tenantB' },\n      10 |     data: { name: 'Bob B' }\n        at /Users/akhil/erp-platform/apps/generated/demo-salon/tests/tenant-isolation.spec.ts:7:24\n\n  3 failed\n    tests/checkout-zip.spec.ts:3:5 › ZIP override affects tax and total (adaptive tip) ─────────────\n    tests/checkout.spec.ts:3:5 › checkout computes tax and writes ledger ───────────────────────────\n    tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id ─────────────────────", "stdout_lines": ["", "Running 3 tests using 3 workers", "", "  ✘  1 tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id (666ms)", "  ✘  2 tests/checkout-zip.spec.ts:3:5 › ZIP override affects tax and total (adaptive tip) (30.0s)", "  ✘  3 tests/checkout.spec.ts:3:5 › checkout computes tax and writes ledger (30.0s)", "", "", "  1) tests/checkout-zip.spec.ts:3:5 › ZIP override affects tax and total (adaptive tip) ────────────", "", "    \u001b[31mTest timeout of 30000ms exceeded.\u001b[39m", "", "    Error: locator.fill: Test timeout of 30000ms exceeded.", "    Call log:", "    \u001b[2m  - waiting for getByRole('textbox', { name: /Item name/i }).first()\u001b[22m", "", "", "       5 |", "       6 |   // One $100 line item", "    >  7 |   await page.getByRole('textbox', { name: /Item name/i }).first().fill('Demo Item');", "         |                                                                   ^", "       8 |   const amountInputs = await page.getByPlaceholder('Amount').all();", "       9 |   await amountInputs[0].fill('100');", "      10 |", "        at /Users/akhil/erp-platform/apps/generated/demo-salon/tests/checkout-zip.spec.ts:7:67", "", "    Error Context: test-results/checkout-zip-ZIP-override--428f9-tax-and-total-adaptive-tip-/error-context.md", "", "  2) tests/checkout.spec.ts:3:5 › checkout computes tax and writes ledger ──────────────────────────", "", "    \u001b[31mTest timeout of 30000ms exceeded.\u001b[39m", "", "    Error: locator.click: Test timeout of 30000ms exceeded.", "    Call log:", "    \u001b[2m  - waiting for getByRole('button', { name: 'Compute & Save' })\u001b[22m", "", "", "       5 |", "       6 |   // Ensure default row exists", "    >  7 |   await page.getByRole('button', { name: 'Compute & Save' }).click();", "         |                                                              ^", "       8 |", "       9 |   // Wait for totals to render", "      10 |   await expect(page.getByText('Subtotal:')).toBeVisible();", "        at /Users/akhil/erp-platform/apps/generated/demo-salon/tests/checkout.spec.ts:7:62", "", "    Error Context: test-results/checkout-checkout-computes-tax-and-writes-ledger/error-context.md", "", "  3) tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id ────────────────────", "", "    Error: \u001b[2mexpect(\u001b[22m\u001b[31mreceived\u001b[39m\u001b[2m).\u001b[22mtoBeTruthy\u001b[2m()\u001b[22m", "", "    Received: \u001b[31mfalse\u001b[39m", "", "       5 |     data: { name: 'Alice A' }", "       6 |   });", "    >  7 |   expect(createA.ok()).toBeTruthy();", "         |                        ^", "       8 |   const createB = await request.post('/api/customer', {", "       9 |     headers: { 'x-tenant-id': 'tenantB' },", "      10 |     data: { name: 'Bob B' }", "        at /Users/akhil/erp-platform/apps/generated/demo-salon/tests/tenant-isolation.spec.ts:7:24", "", "  3 failed", "    tests/checkout-zip.spec.ts:3:5 › ZIP override affects tax and total (adaptive tip) ─────────────", "    tests/checkout.spec.ts:3:5 › checkout computes tax and writes ledger ───────────────────────────", "    tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id ─────────────────────"]}

PLAY RECAP *********************************************************************
localhost                  : ok=33   changed=6    unreachable=0    failed=1    skipped=1    rescued=0    ignored=0   

