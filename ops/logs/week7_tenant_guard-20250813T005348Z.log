
PLAY [Week 7 – Tenant guard (SQLite dev) + tests + git] ************************

TASK [Ensure app folder exists] ************************************************
ok: [localhost]

TASK [Stop if app not found] ***************************************************
skipping: [localhost]

TASK [Write lib/db-tenant.ts (idempotent, hardened + proxy fallback)] **********
changed: [localhost]

TASK [Ensure Tenant model exists (append if missing)] **************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [ansible.builtin.lineinfile] **********************************************
ok: [localhost]

TASK [Stat checkout route] *****************************************************
ok: [localhost]

TASK [Checkout API uses dbForTenant import] ************************************
ok: [localhost]

TASK [Remove module-level PrismaClient in checkout] ****************************
ok: [localhost]

TASK [Inject tenant-scoped db in POST handler (checkout)] **********************
ok: [localhost]

TASK [Customer list route import] **********************************************
ok: [localhost]

TASK [Remove module-level PrismaClient in customer list] ***********************
ok: [localhost]

TASK [Inject tenant-scoped db in GET (customer list)] **************************
ok: [localhost]

TASK [Inject tenant-scoped db in POST (customer create)] ***********************
ok: [localhost]

TASK [Customer by id route import] *********************************************
ok: [localhost]

TASK [Remove module-level PrismaClient in customer by id] **********************
ok: [localhost]

TASK [Inject tenant-scoped db in GET (customer by id)] *************************
ok: [localhost]

TASK [Ensure .env has DATABASE_URL (SQLite dev)] *******************************
ok: [localhost]

TASK [Prisma generate] *********************************************************
changed: [localhost]

TASK [Prisma migrate dev (add tenant fields)] **********************************
changed: [localhost]

TASK [Unit test for tenant guard (Jest)] ***************************************
ok: [localhost]

TASK [Ensure playwright config uses ./tests] ***********************************
ok: [localhost]

TASK [E2E – customer isolation via API] ****************************************
ok: [localhost]

TASK [Run unit tests (Jest)] ***************************************************
changed: [localhost]

TASK [Run e2e (Playwright)] ****************************************************
fatal: [localhost]: FAILED! => {"changed": true, "cmd": "npm run -s e2e", "delta": "0:00:05.000213", "end": "2025-08-12 17:54:00.544373", "msg": "non-zero return code", "rc": 1, "start": "2025-08-12 17:53:55.544160", "stderr": "\u001b[2m[WebServer] \u001b[22m \u001b[31m\u001b[1m⨯\u001b[22m\u001b[39m app/api/customer/route.ts (4:15) @ db\n\u001b[2m[WebServer] \u001b[22m \u001b[31m\u001b[1m⨯\u001b[22m\u001b[39m ReferenceError: db is not defined\n\u001b[2m[WebServer] \u001b[22m    at eval (webpack-internal:///(rsc)/./app/api/customer/route.ts:10:15)\n\u001b[2m[WebServer] \u001b[22m    at (rsc)/./app/api/customer/route.ts \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:62:1\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at __webpack_require__ \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/webpack-runtime.js:33:42\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at eval (webpack-internal:///(rsc)/./node_modules/\u001b[4mnext\u001b[24m/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fcustomer%2Froute&page=%2Fapi%2Fcustomer%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fcustomer%2Froute.ts&appDir=%2FUsers%2Fakhil%2Ferp-platform%2Fapps%2Fgenerated%2Fdemo-salon%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fakhil%2Ferp-platform%2Fapps%2Fgenerated%2Fdemo-salon&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!:15:135)\n\u001b[2m[WebServer] \u001b[22m    at (rsc)/./node_modules/\u001b[4mnext\u001b[24m/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fcustomer%2Froute&page=%2Fapi%2Fcustomer%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fcustomer%2Froute.ts&appDir=%2FUsers%2Fakhil%2Ferp-platform%2Fapps%2Fgenerated%2Fdemo-salon%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fakhil%2Ferp-platform%2Fapps%2Fgenerated%2Fdemo-salon&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:52:1\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at __webpack_require__ \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/webpack-runtime.js:33:42\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at __webpack_exec__ \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:82:39\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at \u001b[90m/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:83:83\n\u001b[2m[WebServer] \u001b[22m    at __webpack_require__.X \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/webpack-runtime.js:168:21\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at \u001b[90m/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:83:47\n\u001b[2m[WebServer] \u001b[22m    at Object.<anonymous> \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:86:3\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m\u001b[90m    at Module._compile (node:internal/modules/cjs/loader:1738:14)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m\u001b[90m    at Object..js (node:internal/modules/cjs/loader:1871:10)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m\u001b[90m    at Module.load (node:internal/modules/cjs/loader:1470:32)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m\u001b[90m    at Module._load (node:internal/modules/cjs/loader:1290:12)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m\u001b[90m    at TracingChannel.traceSync (node:diagnostics_channel:322:14)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m\u001b[90m    at wrapModuleLoad (node:internal/modules/cjs/loader:238:24)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m\u001b[90m    at Module.<anonymous> (node:internal/modules/cjs/loader:1493:12)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at mod.require \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/require-hook.js:65:28\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m\u001b[90m    at require (node:internal/modules/helpers:152:16)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at requirePage \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/require.js:109:84\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at \u001b[90m/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/load-components.js:103:84\n\u001b[2m[WebServer] \u001b[22m    at async loadComponentsImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/load-components.js:103:26\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async DevServer.findPageComponentsImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/next-server.js:714:36\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async DevServer.findPageComponents \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/dev/next-dev-server.js:577:20\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async DevServer.renderPageComponent \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/base-server.js:1910:24\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async DevServer.renderToResponseImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/base-server.js:1962:32\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async DevServer.pipeImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/base-server.js:922:25\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async NextNodeServer.handleCatchallRenderRequest \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/next-server.js:272:17\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async DevServer.handleRequestImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/base-server.js:818:17\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async \u001b[90m/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/dev/next-dev-server.js:339:20\n\u001b[2m[WebServer] \u001b[22m    at async Span.traceAsyncFn \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/trace/trace.js:154:20\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async DevServer.handleRequest \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/dev/next-dev-server.js:336:24\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async invokeRender \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/lib/router-server.js:179:21\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async handleRequest \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/lib/router-server.js:359:24\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async requestHandlerImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/lib/router-server.js:383:13\u001b[90m)\u001b[39m\n\u001b[2m[WebServer] \u001b[22m    at async Server.requestListener \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/lib/start-server.js:141:13\u001b[90m)\u001b[39m {\n\u001b[2m[WebServer] \u001b[22m  page: \u001b[32m'/api/customer'\u001b[39m\n\u001b[2m[WebServer] \u001b[22m}\n\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m 2 |\u001b[39m \u001b[36mimport\u001b[39m { dbForTenant } \u001b[36mfrom\u001b[39m \u001b[32m'@/lib/db-tenant'\u001b[39m\u001b[33m;\u001b[39m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m 3 |\u001b[39m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m\u001b[0m\u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 4 |\u001b[39m \u001b[36mconst\u001b[39m model \u001b[33m=\u001b[39m db\u001b[33m.\u001b[39mcustomer\u001b[33m;\u001b[39m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m   |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m 5 |\u001b[39m\u001b[0m\n\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m 6 |\u001b[39m \u001b[36mexport\u001b[39m \u001b[36masync\u001b[39m \u001b[36mfunction\u001b[39m \u001b[33mGET\u001b[39m(req\u001b[33m:\u001b[39m \u001b[33mNextRequest\u001b[39m) {\u001b[0m\n\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m 7 |\u001b[39m \u001b[90m// BEGIN ANSIBLE TENANT DB GET\u001b[39m\u001b[0m", "stderr_lines": ["\u001b[2m[WebServer] \u001b[22m \u001b[31m\u001b[1m⨯\u001b[22m\u001b[39m app/api/customer/route.ts (4:15) @ db", "\u001b[2m[WebServer] \u001b[22m \u001b[31m\u001b[1m⨯\u001b[22m\u001b[39m ReferenceError: db is not defined", "\u001b[2m[WebServer] \u001b[22m    at eval (webpack-internal:///(rsc)/./app/api/customer/route.ts:10:15)", "\u001b[2m[WebServer] \u001b[22m    at (rsc)/./app/api/customer/route.ts \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:62:1\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at __webpack_require__ \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/webpack-runtime.js:33:42\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at eval (webpack-internal:///(rsc)/./node_modules/\u001b[4mnext\u001b[24m/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fcustomer%2Froute&page=%2Fapi%2Fcustomer%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fcustomer%2Froute.ts&appDir=%2FUsers%2Fakhil%2Ferp-platform%2Fapps%2Fgenerated%2Fdemo-salon%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fakhil%2Ferp-platform%2Fapps%2Fgenerated%2Fdemo-salon&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!:15:135)", "\u001b[2m[WebServer] \u001b[22m    at (rsc)/./node_modules/\u001b[4mnext\u001b[24m/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fcustomer%2Froute&page=%2Fapi%2Fcustomer%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fcustomer%2Froute.ts&appDir=%2FUsers%2Fakhil%2Ferp-platform%2Fapps%2Fgenerated%2Fdemo-salon%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fakhil%2Ferp-platform%2Fapps%2Fgenerated%2Fdemo-salon&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:52:1\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at __webpack_require__ \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/webpack-runtime.js:33:42\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at __webpack_exec__ \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:82:39\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at \u001b[90m/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:83:83", "\u001b[2m[WebServer] \u001b[22m    at __webpack_require__.X \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/webpack-runtime.js:168:21\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at \u001b[90m/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:83:47", "\u001b[2m[WebServer] \u001b[22m    at Object.<anonymous> \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39m.next/server/app/api/customer/route.js:86:3\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m\u001b[90m    at Module._compile (node:internal/modules/cjs/loader:1738:14)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m\u001b[90m    at Object..js (node:internal/modules/cjs/loader:1871:10)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m\u001b[90m    at Module.load (node:internal/modules/cjs/loader:1470:32)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m\u001b[90m    at Module._load (node:internal/modules/cjs/loader:1290:12)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m\u001b[90m    at TracingChannel.traceSync (node:diagnostics_channel:322:14)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m\u001b[90m    at wrapModuleLoad (node:internal/modules/cjs/loader:238:24)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m\u001b[90m    at Module.<anonymous> (node:internal/modules/cjs/loader:1493:12)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at mod.require \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/require-hook.js:65:28\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m\u001b[90m    at require (node:internal/modules/helpers:152:16)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at requirePage \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/require.js:109:84\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at \u001b[90m/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/load-components.js:103:84", "\u001b[2m[WebServer] \u001b[22m    at async loadComponentsImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/load-components.js:103:26\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async DevServer.findPageComponentsImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/next-server.js:714:36\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async DevServer.findPageComponents \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/dev/next-dev-server.js:577:20\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async DevServer.renderPageComponent \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/base-server.js:1910:24\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async DevServer.renderToResponseImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/base-server.js:1962:32\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async DevServer.pipeImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/base-server.js:922:25\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async NextNodeServer.handleCatchallRenderRequest \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/next-server.js:272:17\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async DevServer.handleRequestImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/base-server.js:818:17\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async \u001b[90m/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/dev/next-dev-server.js:339:20", "\u001b[2m[WebServer] \u001b[22m    at async Span.traceAsyncFn \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/trace/trace.js:154:20\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async DevServer.handleRequest \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/dev/next-dev-server.js:336:24\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async invokeRender \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/lib/router-server.js:179:21\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async handleRequest \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/lib/router-server.js:359:24\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async requestHandlerImpl \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/lib/router-server.js:383:13\u001b[90m)\u001b[39m", "\u001b[2m[WebServer] \u001b[22m    at async Server.requestListener \u001b[90m(/Users/akhil/erp-platform/apps/generated/demo-salon/\u001b[39mnode_modules/\u001b[4mnext\u001b[24m/dist/server/lib/start-server.js:141:13\u001b[90m)\u001b[39m {", "\u001b[2m[WebServer] \u001b[22m  page: \u001b[32m'/api/customer'\u001b[39m", "\u001b[2m[WebServer] \u001b[22m}", "\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m 2 |\u001b[39m \u001b[36mimport\u001b[39m { dbForTenant } \u001b[36mfrom\u001b[39m \u001b[32m'@/lib/db-tenant'\u001b[39m\u001b[33m;\u001b[39m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m 3 |\u001b[39m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m\u001b[0m\u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 4 |\u001b[39m \u001b[36mconst\u001b[39m model \u001b[33m=\u001b[39m db\u001b[33m.\u001b[39mcustomer\u001b[33m;\u001b[39m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m   |\u001b[39m               \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m 5 |\u001b[39m\u001b[0m", "\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m 6 |\u001b[39m \u001b[36mexport\u001b[39m \u001b[36masync\u001b[39m \u001b[36mfunction\u001b[39m \u001b[33mGET\u001b[39m(req\u001b[33m:\u001b[39m \u001b[33mNextRequest\u001b[39m) {\u001b[0m", "\u001b[2m[WebServer] \u001b[22m\u001b[0m \u001b[90m 7 |\u001b[39m \u001b[90m// BEGIN ANSIBLE TENANT DB GET\u001b[39m\u001b[0m"], "stdout": "\nRunning 3 tests using 3 workers\n\n  ✘  1 tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id (579ms)\n  ✓  3 tests/checkout-zip.spec.ts:3:5 › ZIP override affects tax and total (adaptive tip) (733ms)\n  ✓  2 tests/checkout.spec.ts:3:5 › checkout computes tax and writes ledger (785ms)\n\n\n  1) tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id ────────────────────\n\n    Error: \u001b[2mexpect(\u001b[22m\u001b[31mreceived\u001b[39m\u001b[2m).\u001b[22mtoBeTruthy\u001b[2m()\u001b[22m\n\n    Received: \u001b[31mfalse\u001b[39m\n\n       5 |     data: { name: 'Alice A' }\n       6 |   });\n    >  7 |   expect(createA.ok()).toBeTruthy();\n         |                        ^\n       8 |   const createB = await request.post('/api/customer', {\n       9 |     headers: { 'x-tenant-id': 'tenantB' },\n      10 |     data: { name: 'Bob B' }\n        at /Users/akhil/erp-platform/apps/generated/demo-salon/tests/tenant-isolation.spec.ts:7:24\n\n  1 failed\n    tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id ─────────────────────\n  2 passed (4.3s)", "stdout_lines": ["", "Running 3 tests using 3 workers", "", "  ✘  1 tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id (579ms)", "  ✓  3 tests/checkout-zip.spec.ts:3:5 › ZIP override affects tax and total (adaptive tip) (733ms)", "  ✓  2 tests/checkout.spec.ts:3:5 › checkout computes tax and writes ledger (785ms)", "", "", "  1) tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id ────────────────────", "", "    Error: \u001b[2mexpect(\u001b[22m\u001b[31mreceived\u001b[39m\u001b[2m).\u001b[22mtoBeTruthy\u001b[2m()\u001b[22m", "", "    Received: \u001b[31mfalse\u001b[39m", "", "       5 |     data: { name: 'Alice A' }", "       6 |   });", "    >  7 |   expect(createA.ok()).toBeTruthy();", "         |                        ^", "       8 |   const createB = await request.post('/api/customer', {", "       9 |     headers: { 'x-tenant-id': 'tenantB' },", "      10 |     data: { name: 'Bob B' }", "        at /Users/akhil/erp-platform/apps/generated/demo-salon/tests/tenant-isolation.spec.ts:7:24", "", "  1 failed", "    tests/tenant-isolation.spec.ts:2:5 › customers are isolated by x-tenant-id ─────────────────────", "  2 passed (4.3s)"]}

PLAY RECAP *********************************************************************
localhost                  : ok=31   changed=4    unreachable=0    failed=1    skipped=1    rescued=0    ignored=0   

